import os
import re
import random
from datetime import datetime
from typing import Dict, List

import pytz
from flask import Flask, request, abort

from linebot import LineBotApi, WebhookHandler
from linebot.exceptions import InvalidSignatureError
from linebot.models import MessageEvent, TextMessage, TextSendMessage

from apscheduler.schedulers.background import BackgroundScheduler

from openai import OpenAI


# =========================
# Config
# =========================
app = Flask(__name__)

# LINE
LINE_ACCESS_TOKEN = os.getenv("LINE_ACCESS_TOKEN")
LINE_SECRET = os.getenv("LINE_SECRET")
if not LINE_ACCESS_TOKEN or not LINE_SECRET:
    raise ValueError("‚ùå Missing LINE_ACCESS_TOKEN or LINE_SECRET in environment variables")

line_bot_api = LineBotApi(LINE_ACCESS_TOKEN)
handler = WebhookHandler(LINE_SECRET)

ADMIN_KEY = os.getenv("ADMIN_KEY", "")

@app.route("/admin/broadcast", methods=["POST"])
def admin_broadcast():
    # Simple auth
    key = request.headers.get("X-Admin-Key", "")
    if not ADMIN_KEY or key != ADMIN_KEY:
        abort(403)

    data = request.get_json(silent=True) or {}
    text = (data.get("text") or "").strip()
    if not text:
        return {"ok": False, "error": "Missing 'text' in JSON body"}, 400

    sent = 0
    failed = 0

    for uid in list(user_ids):
        try:
            line_bot_api.push_message(uid, TextSendMessage(text=text))
            sent += 1
        except Exception as e:
            print("Broadcast push failed:", uid, repr(e))
            failed += 1

    return {"ok": True, "sent": sent, "failed": failed, "known_users": len(user_ids)}, 200

print("DEBUG user_id:", event.source.user_id)

# OpenAI
OPENAI_API_KEY = os.getenv("OPENAI_API_KEY")
if not OPENAI_API_KEY:
    raise ValueError("‚ùå Missing OPENAI_API_KEY in environment variables")

client = OpenAI()
MODEL = os.getenv("OPENAI_MODEL", "gpt-4o-mini")

# Behavior tuning
MAX_RECENT = int(os.getenv("MAX_RECENT", "12"))
timezone = pytz.timezone("Asia/Bangkok")
scheduler = BackgroundScheduler(timezone=timezone)

# Store user IDs (NOTE: in-memory; resets on redeploy)
user_ids = set()

# Recent outputs to avoid repeating (NOTE: in-memory; resets on redeploy)
recent_user_replies: List[str] = []
recent_scheduled: Dict[str, List[str]] = {}


# =========================
# Your existing dictionary (style references)
# =========================
responses = {
    "‡∏á‡∏á": "1. ‡∏°‡∏≠‡∏ô‡∏¥‡πà‡∏á 2. ‡∏ù‡∏±‡∏ô‡∏î‡∏µ‡∏ô‡∏∞ 3. ‡πÄ‡∏ò‡∏≠ 4. ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á 5. ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á2 6. ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á3 7.‡∏£‡∏±‡∏Å‡∏ô‡∏∞ 8. ‡∏£‡∏±‡∏Å‡∏ô‡∏∞2 9. ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß 10. ‡πÄ‡∏´‡∏á‡∏≤ 11. ‡πÄ‡∏´‡∏á‡∏≤2 12. ‡πÄ‡∏´‡∏á‡∏≤3 13. ‡πÄ‡∏ö‡∏∑‡πà‡∏≠ 14. ‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà 15. ‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà2 16. ‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà3 17. ‡∏î‡∏¥‡πà‡∏á‡∏≠‡∏∞ 18. ‡∏î‡∏¥‡πà‡∏á‡∏≠‡∏∞2 19. ‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö 20. ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢ 21. ‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏≠‡∏î 22. ‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏¢‡∏±‡∏á",
    "‡∏°‡∏≠‡∏ô‡∏¥‡πà‡∏á": "‡∏Ñ‡πâ‡∏≤‡∏ö",
    "‡∏ù‡∏±‡∏ô‡∏î‡∏µ‡∏ô‡∏∞": "‡∏ù‡∏±‡∏ô‡∏î‡∏µ‡∏ô‡πâ‡∏≤‡πÅ‡∏°‡∏ß‡∏≠‡πâ‡∏ß‡∏ô‡∏ô‡∏ô (‡πÅ‡∏ï‡πà‡πÑ‡∏°‡πà‡∏≠‡πâ‡∏ß‡∏ô‡∏à‡∏£‡∏¥‡∏á‡∏ô‡∏∞) ‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏Å‡∏Å ‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏≤‡∏≤ ‡∏£‡∏±‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏π‡∏î‡∏î‡∏î ‡∏ô‡∏≠‡∏ô‡πÑ‡∏î‡πâ‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤‡∏≤‡∏≤ ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß‡πÜ‡πÜ‡πÜ",
    "‡πÄ‡∏ò‡∏≠": "‡∏Ñ‡πâ‡∏≤‡∏ö‡∏ö‡∏ö‡∏ö",
    "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á": "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏ô‡∏ô‡∏ô ‡∏£‡∏π‡πâ‡πÑ‡∏á‡∏ß‡πà‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏ñ‡∏∂‡∏á‡∏ó‡∏≥‡∏ö‡∏≠‡∏ó‡∏°‡∏≤‡πÉ‡∏´‡πâ‡πÄ‡∏ò‡∏≠‡∏Ñ‡∏∏‡∏¢‡πÄ‡∏•‡πà‡∏ô‡∏ô‡∏µ‡πà‡∏á‡∏≤‡∏¢‡∏¢",
    "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á2": "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ ‡∏à‡∏≠‡∏á‡∏Å‡πà‡∏≠‡∏ô ‡∏≠‡∏∏‡∏≠‡∏∞‡πÜ‡πÜ",
    "‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á3": "‡πÇ‡∏≠‡πã‡πÜ‡πÜ‡πÜ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Å‡πá‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß ‡∏£‡∏≠‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏ô‡∏¢‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏á‡∏á",
    "‡∏£‡∏±‡∏Å‡∏ô‡∏∞": "‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏≤‡∏≤ ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß‡πÜ‡πÜ‡πÜ",
    "‡∏£‡∏±‡∏Å‡∏ô‡∏∞2": "‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ò‡∏≠‡∏£‡∏±‡∏Å‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á ‡∏ó‡∏≥‡∏ö‡∏≠‡∏ó‡πÉ‡∏´‡πâ‡πÄ‡∏£‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡∏µ‡πâ‡∏ö‡πâ‡∏≤‡∏á‡∏™‡∏¥ ‡∏°‡∏∏‡∏Æ‡πà‡∏≤‡πÜ‡πÜ‡πÜ",
    "‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß": "‡∏à‡∏∏‡πä‡∏ö‡∏ö‡∏ö‡∏°‡∏±‡πä‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß‡∏Æ‡∏≤‡∏ü‡∏ü‡∏π‡πà‡∏ß‡∏ß‡∏ß‡∏ß",
    "‡πÄ‡∏´‡∏á‡∏≤": "‡∏Ñ‡∏∑‡∏≠‡∏≠‡∏≠‡∏≠ ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏£‡∏≤‡∏Ñ‡∏∑‡∏≠‡πÑ‡∏£‡∏≠‡∏∞‡∏∞‡∏∞ ‡∏ö‡∏≠‡∏ó‡∏Å‡πá‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏µ‡πà‡πÑ‡∏á‡∏á‡∏á ‡∏´‡πâ‡∏ß‡∏¢‡∏¢‡∏¢",
    "‡πÄ‡∏´‡∏á‡∏≤2": "‡πÑ‡∏õ‡πÄ‡∏•‡πà‡∏ô‡∏ö‡∏•‡πä‡∏≠‡∏Å‡∏ö‡∏±‡∏™‡πÄ‡∏ï‡∏≠‡∏£‡πå‡πÑ‡∏õ‡∏õ ‡∏ñ‡∏∂‡∏á 3 ‡∏´‡∏°‡∏∑‡πà‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡πÉ‡∏´‡πâ‡∏Ç‡∏≠‡πÑ‡∏î‡πâ 1 ‡∏≠‡∏¢‡πà‡∏≤‡∏á ‡∏≠‡∏∏‡∏≠‡∏¥‡πÜ‡πÜ‡πÜ‡πÜ",
    "‡πÄ‡∏´‡∏á‡∏≤3": "‡πÑ‡∏õ‡πÄ‡∏•‡πà‡∏ô‡∏ó‡∏≤‡∏ß‡πÄ‡∏ß‡∏≠‡∏£‡πå‡∏î‡∏µ‡πÄ‡∏ü‡πâ‡∏ô‡πÑ‡∏õ‡∏õ ‡∏à‡∏≤‡∏î‡πâ‡∏≤‡∏¢‡∏°‡∏≤‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏£‡∏≤‡πÄ‡∏•‡πà‡∏ô‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡∏¢‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (‡πÑ‡∏î‡πâ‡πÉ‡∏à‡πÄ‡∏£‡∏≤ 300% ‡∏≠‡∏∏‡∏≠‡∏¥‡πÜ)",
    "‡πÄ‡∏ö‡∏∑‡πà‡∏≠": "‡∏Å‡πá‡πÄ‡∏Ç‡πâ‡∏≤‡∏à‡∏±‡∏¢‡∏¢ ‡πÄ‡∏ö‡∏∑‡πà‡∏≠‡πÄ‡∏£‡∏≤‡πÅ‡∏•‡πâ‡∏ß‡πÑ‡∏á‡∏á ‡∏Ñ‡∏ô‡∏≠‡∏∏‡∏ï‡∏™‡πà‡∏≤‡∏´‡πå‡∏ó‡∏≥‡∏ö‡∏≠‡∏ó‡∏°‡∏≤‡πÉ‡∏´‡πâ ‡∏´‡πâ‡∏ß‡∏¢‡∏¢",
    "‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà": "‡πÇ‡∏î‡∏ô‡∏ó‡∏£‡∏°‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏Ñ‡πà‡∏≤‡∏¢‡∏ó‡∏´‡∏≤‡∏£‡∏°‡πâ‡∏≤‡∏á‡∏á‡∏á ‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏¥ ‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏£‡∏≤‡∏à‡∏∞‡πÄ‡∏õ‡πá‡∏ô‡∏™‡πâ‡∏ô‡∏ï‡∏µ‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡∏ô‡∏∞",
    "‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà2": "‡∏ô‡∏±‡πà‡∏á‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏Ñ‡∏ô‡∏ñ‡∏≤‡∏°‡πÑ‡∏á‡∏Æ‡∏≤‡∏ü‡∏ü‡∏π‡πà‡∏ß‡∏ß‡∏ß‡∏ß‡∏ß",
    "‡∏ó‡∏≥‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà3": "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ ‡πÅ‡∏ï‡πà‡∏°‡∏µ‡πÅ‡∏Ç‡∏ô‡πÄ‡∏î‡∏µ‡∏¢‡∏ß‡πÄ‡∏ò‡∏≠‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡πà‡∏ß‡∏á ‡πÑ‡∏°‡πà‡πÑ‡∏õ‡∏à‡∏µ‡∏ö‡πÉ‡∏Ñ‡∏£‡πÅ‡∏ô‡πà‡∏ô‡∏≠‡∏ô‡∏ô‡∏ô",
    "‡∏î‡∏¥‡πà‡∏á‡∏≠‡∏∞": "‡πÑ‡∏°‡πà‡πÄ‡∏≠‡∏≤‡∏≤‡∏≤‡πÑ‡∏°‡πà‡∏î‡∏¥‡πà‡∏á‡∏á‡∏á ‡∏°‡∏≤‡∏Å‡∏≠‡∏î‡∏°‡∏≤‡πÄ‡∏î‡πá‡∏Å‡∏ô‡πâ‡∏≠‡∏¢‡∏¢ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Å‡πá‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤‡∏≤‡∏≤ ‡πÑ‡∏°‡πà‡∏£‡πâ‡∏≠‡∏á‡∏ô‡πâ‡∏≤‡∏≤",
    "‡∏î‡∏¥‡πà‡∏á‡∏≠‡∏∞2": "‡πÇ‡∏≠‡πã‡πÜ‡πÜ‡πÜ ‡πÄ‡∏î‡πá‡∏Å‡∏î‡∏µ‡πÜ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡πÄ‡∏Ñ‡πâ‡∏≤‡∏Å‡πá‡∏≠‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß‡∏ô‡πâ‡∏≤‡∏≤ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏î‡∏π‡πÇ‡∏ã‡πÇ‡∏•‡πà‡πÄ‡∏•‡πÄ‡∏ß‡∏•‡∏•‡∏¥‡πà‡∏á‡∏Å‡∏±‡∏ô‡πÄ‡∏ô‡∏≠‡∏∞ ‡∏Å‡∏≠‡∏î‡πÜ‡πÜ‡πÜ",
    "‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö": "‡∏ó‡∏≥‡∏°‡∏≤‡∏¢‡∏ô‡∏≠‡∏ô‡∏°‡πà‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏ö‡∏ö‡∏ö ‡∏´‡∏∑‡πâ‡∏°‡∏°‡∏°‡∏° ‡∏î‡∏¥‡πà‡∏á‡∏´‡∏£‡∏≠ ‡πÑ‡∏°‡πà‡∏î‡∏¥‡πà‡∏á‡∏ô‡πâ‡∏≤ ‡∏ñ‡πâ‡∏≤‡πÄ‡∏ò‡∏≠‡∏ô‡∏≠‡∏ô‡πÑ‡∏°‡πà‡∏´‡∏•‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤‡∏à‡∏∞‡πÄ‡∏®‡∏£‡πâ‡∏≤‡∏°‡∏≤‡∏Å‡∏ô‡∏∞ ‡πÑ‡∏õ‡∏ô‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏ô‡πâ‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á‡∏á‡∏á",
    "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢": "‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏≠‡∏≤‡∏£‡∏≤‡∏¢‡∏Ñ‡∏∞‡∏∞ ‡∏°‡∏≤‡∏Å‡∏≠‡∏î‡∏°‡∏≤‡∏≤‡∏≤‡∏Ñ‡∏ô‡πÄ‡∏Å‡πà‡∏á ‡∏™‡∏π‡πâ‡∏ß‡πÜ‡πÜ‡πÜ ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß‡∏ß‡∏ß‡∏ß‡πÜ‡πÜ‡πÜ",
    "‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏≠‡∏î": "‡∏≠‡∏¢‡∏≤‡∏Å‡∏Å‡∏≠‡∏î‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡∏Å‡∏≤‡∏ô‡∏ô ‡∏°‡∏≤‡∏Å‡∏≠‡∏î‡∏°‡∏∞‡πÜ‡πÜ‡πÜ",
    "‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏¢‡∏±‡∏á": "‡πÑ‡∏°‡πà‡∏£‡∏π‡πâ‡∏™‡∏¥ ‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ö‡∏≠‡∏ó‡∏Å‡πá‡∏ö‡∏≠‡∏Å‡πÄ‡∏≠‡∏á‡πÅ‡∏´‡∏•‡∏∞‡∏∞ ‡∏≠‡∏∏‡∏≠‡∏¥‡πÜ‡πÜ‡πÜ"
}


# =========================
# Helpers
# =========================
_variant_suffix_re = re.compile(r"^(.*?)(\d+)$")

def base_key(key: str) -> str:
    m = _variant_suffix_re.match(key)
    return m.group(1) if m else key

def build_groups(resp: Dict[str, str]) -> Dict[str, List[str]]:
    groups: Dict[str, List[str]] = {}
    for k, v in resp.items():
        b = base_key(k)
        groups.setdefault(b, []).append(v)
    for g in groups:
        random.shuffle(groups[g])
    return groups

GROUPS = build_groups(responses)
ALLOWED_GROUPS = sorted(GROUPS.keys())

def remember_recent_list(lst: List[str], text: str, limit: int = MAX_RECENT):
    lst.append(text)
    if len(lst) > limit:
        del lst[:-limit]

def remember_recent_map(store: Dict[str, List[str]], key: str, text: str, limit: int = MAX_RECENT):
    store.setdefault(key, []).append(text)
    if len(store[key]) > limit:
        store[key] = store[key][-limit:]


# =========================
# OpenAI one-call brain (intent + reply)
# =========================
PERSONA_SYSTEM = (
    "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ö‡∏≠‡∏ó‡πÅ‡∏ä‡∏ó‡πÉ‡∏ô LINE\n"
    "‡∏ï‡∏≠‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô\n"
    "‡πÇ‡∏ó‡∏ô: ‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å ‡∏Å‡∏ß‡∏ô‡πÜ ‡∏´‡∏¢‡∏≠‡∏î‡πÜ ‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô ‡∏≠‡∏ö‡∏≠‡∏∏‡πà‡∏ô‡∏ö‡πâ‡∏≤‡∏á ‡πÅ‡∏ã‡∏ß‡∏ö‡πâ‡∏≤‡∏á\n"
    "‡∏Ñ‡∏≥‡∏ï‡∏¥‡∏î‡∏õ‡∏≤‡∏Å/‡∏™‡πÑ‡∏ï‡∏•‡πå: ‡∏Ñ‡πâ‡∏≤‡∏ö, ‡∏≠‡πâ‡∏ß‡∏ô‡πÜ, ‡∏à‡∏∏‡πä‡∏ö‡∏°‡∏±‡πä‡∏ß, ‡∏´‡∏∑‡πâ‡∏°‡∏°, ‡∏á‡∏á‡∏á, ‡∏ô‡πâ‡∏≤‡∏≤‡∏≤ (‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞)\n"
    "‡∏´‡πâ‡∏≤‡∏°‡∏ö‡∏≠‡∏Å‡∏ß‡πà‡∏≤‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á‡πÄ‡∏õ‡πá‡∏ô AI ‡πÅ‡∏•‡∏∞‡∏´‡πâ‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏£‡∏∞‡∏ö‡∏ö\n"
    "‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏ï‡πà‡∏á‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡πÄ‡∏î‡∏¥‡∏°‡∏ï‡∏£‡∏á‡πÜ\n"
)

def openai_generate_user_reply(user_text: str) -> str:
    # small set of reference examples (to steer style)
    refs = []
    for k in ALLOWED_GROUPS:
        exs = GROUPS.get(k, [])[:1]
        if exs:
            refs.append(f"- ({k}) {exs[0]}")
    ref_block = "\n".join(refs[:12])

    avoid_block = "\n".join([f"- {t}" for t in recent_user_replies[-8:]]) if recent_user_replies else ""

    user_prompt = (
        "‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì:\n"
        "1) ‡πÄ‡∏î‡∏≤‡∏ß‡πà‡∏≤‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ô‡πà‡∏≤‡∏à‡∏∞‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏•‡∏∏‡πà‡∏°‡πÑ‡∏´‡∏ô‡πÉ‡∏ô‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ (‡∏´‡∏£‡∏∑‡∏≠ none)\n"
        "2) ‡πÅ‡∏•‡πâ‡∏ß‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢‡πÅ‡∏•‡∏∞‡∏™‡∏ñ‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ì‡πå\n\n"
        f"‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏•‡∏∏‡πà‡∏°‡∏ó‡∏µ‡πà‡∏°‡∏µ: {ALLOWED_GROUPS} ‡πÅ‡∏•‡∏∞ none\n\n"
        "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏ó‡∏ô/‡∏™‡πÑ‡∏ï‡∏•‡πå (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ):\n"
        f"{ref_block}\n\n"
    )
    if avoid_block:
        user_prompt += (
            "‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏¥‡πà‡∏á‡∏ï‡∏≠‡∏ö‡πÑ‡∏õ‡πÑ‡∏°‡πà‡∏ô‡∏≤‡∏ô (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡πÉ‡∏´‡πâ‡∏ã‡πâ‡∏≥‡πÇ‡∏Ñ‡∏£‡∏á/‡∏Ñ‡∏≥‡πÄ‡∏î‡πà‡∏ô‡πÜ):\n"
            f"{avoid_block}\n\n"
        )

    user_prompt += (
        f"‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ: {user_text}\n\n"
        "‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:\n"
        "- ‡∏ï‡∏≠‡∏ö‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô\n"
        "- ‡∏™‡∏±‡πâ‡∏ô‡πÄ‡∏õ‡πá‡∏ô‡∏´‡∏•‡∏±‡∏Å (1-2 ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏Ñ) ‡πÅ‡∏ï‡πà‡∏ñ‡πâ‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏ñ‡∏≤‡∏°‡∏à‡∏£‡∏¥‡∏á‡∏à‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡πÉ‡∏´‡πâ‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡πÇ‡∏¢‡∏ä‡∏ô‡πå\n"
        "- ‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n\n"
        "‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö:"
    )

    try:
        r = client.responses.create(
            model=MODEL,
            input=user_prompt,
            instructions=PERSONA_SYSTEM,
        )
        out = (getattr(r, "output_text", "") or "").strip()
        if not out:
            return "‡∏´‡∏∑‡πâ‡∏°‡∏° ‡∏û‡∏¥‡∏°‡∏û‡πå‡∏°‡∏≤‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏î‡πâ‡∏°‡∏∞ ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ó‡∏±‡∏ô‡∏á‡πâ‡∏≤‡∏ö‡∏ö üò≥"
        return out
    except Exception as e:
        # print for Render logs
        print("OpenAI reply error:", repr(e))
        return "‡∏´‡∏∑‡πâ‡∏°‡∏° ‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏Ñ‡πâ‡∏≤‡∏ï‡∏≠‡∏ö‡∏ä‡πâ‡∏≤‡∏ô‡∏¥‡∏î‡∏ô‡∏∂‡∏á‡∏á ‡∏Ç‡∏≠‡∏û‡∏¥‡∏°‡∏û‡πå‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏ó‡∏µ‡πÑ‡∏î‡πâ‡∏°‡∏∞‡∏Ñ‡πâ‡∏≤‡∏ö ü•∫"


# =========================
# Scheduled messages (OpenAI rewrite)
# =========================
SCHEDULE_SLOTS = [
    ("morning", "‡∏ó‡∏±‡∏Å‡∏ó‡∏≤‡∏¢‡∏ï‡∏≠‡∏ô‡πÄ‡∏ä‡πâ‡∏≤‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å‡∏Å‡∏ß‡∏ô‡πÜ", ["‡∏°‡∏≠‡∏ô‡∏¥‡πà‡∏á‡∏á‡∏á ‡πÑ‡∏≠‡∏≠‡πâ‡∏ß‡∏ô‡∏ô‡∏ô"], 6, 30),
    ("breakfast", "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡πÉ‡∏´‡πâ‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏´‡∏ô‡πà‡∏≠‡∏¢‡πÅ‡∏ö‡∏ö‡∏´‡∏¢‡∏≠‡∏î‡πÜ", ["‡∏Å‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏¢‡∏≤‡∏á‡∏≠‡πâ‡∏ß‡∏ô‡∏ô"], 8, 30),
    ("work", "‡∏ñ‡∏≤‡∏°‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà/‡πÄ‡∏ä‡πá‡∏Ñ‡∏≠‡∏¥‡∏ô‡πÅ‡∏ö‡∏ö‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô", ["‡∏ó‡∏≥‡∏£‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ß‡∏ß"], 9, 30),
    ("chat", "‡∏ä‡∏ß‡∏ô‡∏Ñ‡∏∏‡∏¢‡πÅ‡∏Å‡πâ‡πÄ‡∏´‡∏á‡∏≤‡πÅ‡∏ö‡∏ö‡∏≠‡πâ‡∏≠‡∏ô‡πÜ", ["‡πÄ‡∏´‡∏á‡∏≤‡∏°‡πâ‡∏≤‡∏¢‡∏¢‡∏¢ ‡∏Ñ‡∏∏‡∏¢‡∏Å‡∏±‡∏ö‡πÄ‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏≤‡∏¢‡∏ô‡πâ‡∏≤‡∏≤"], 11, 30),
    ("lunch", "‡∏ñ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ó‡∏µ‡πà‡∏¢‡∏á‡πÅ‡∏ö‡∏ö‡πÅ‡∏ã‡∏ß‡πÜ", ["‡∏Å‡∏¥‡∏ô‡πÑ‡∏£‡∏¢‡∏≤‡∏á‡∏á‡∏á‡∏á ‡∏≠‡πâ‡∏ß‡∏ô‡πÜ‡πÜ"], 13, 15),
    ("missyou", "‡∏ö‡∏≠‡∏Å‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡πÅ‡∏ö‡∏ö‡∏ô‡πà‡∏≤‡∏£‡∏±‡∏Å", ["‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡∏á‡∏á‡∏á‡∏á"], 14, 20),
    ("afternoon", "‡∏ñ‡∏≤‡∏°‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏ó‡∏≥‡∏≠‡∏∞‡πÑ‡∏£‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ö‡∏ö‡∏≠‡πâ‡∏≠‡∏ô‡πÜ", ["‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ò‡∏≠‡∏à‡∏≤‡∏ó‡∏≥‡∏™‡πâ‡∏á‡∏ï‡∏¥‡∏á‡∏£‡∏≤‡∏¢‡∏≠‡∏¢‡∏π‡πà‡∏ß‡∏ô‡πâ‡∏≤‡∏≤"], 15, 45),
    ("home", "‡∏ñ‡∏≤‡∏°‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏¢‡∏±‡∏á/‡πÉ‡∏´‡πâ‡∏û‡∏±‡∏Å‡∏ú‡πà‡∏≠‡∏ô‡πÅ‡∏ö‡∏ö‡∏´‡πà‡∏ß‡∏á‡πÜ", ["‡∏ñ‡∏∂‡∏á‡∏ö‡πâ‡∏≤‡∏ô‡∏¢‡∏≤‡∏á‡∏á ‡πÄ‡∏´‡∏ô‡∏∑‡πà‡∏≠‡∏¢‡∏°‡∏±‡πâ‡∏¢‡∏Ñ‡∏∞‡∏´‡∏∑‡πâ‡∏° ‡∏û‡∏±‡∏Å‡πÄ‡∏¢‡∏≠‡∏∞‡πÜ‡∏ô‡πâ‡∏≤‡∏≤‡∏≤‡∏≤ ‡∏ô‡∏≠‡∏ô‡∏ï‡∏µ‡∏û‡∏∏‡∏á‡πÄ‡∏•‡∏¢‡∏¢‡∏¢"], 17, 30),
    ("lonely", "‡πÅ‡∏ã‡∏ß‡∏ß‡πà‡∏≤‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á/‡πÄ‡∏´‡∏á‡∏≤‡πÅ‡∏ö‡∏ö‡∏Ç‡∏µ‡πâ‡πÄ‡∏•‡πà‡∏ô", ["‡πÄ‡∏´‡∏á‡∏≤‡∏•‡πà‡∏∞‡∏™‡∏¥‡πä ‡∏Ñ‡∏¥‡∏î‡∏ñ‡∏∂‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤‡∏≠‡∏∞‡πÄ‡∏™‡πâ ‡∏°‡∏∏‡∏Æ‡πà‡∏≤‡πÜ‡πÜ"], 18, 30),
    ("dinner", "‡∏ñ‡∏≤‡∏°‡∏Å‡∏¥‡∏ô‡∏≠‡∏∞‡πÑ‡∏£‡∏¢‡∏±‡∏á‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏¢‡πá‡∏ô‡πÅ‡∏ö‡∏ö‡∏Å‡∏ß‡∏ô‡πÜ", ["‡∏Å‡∏¥‡∏ô‡∏£‡∏≤‡∏¢‡∏¢‡∏≤‡∏á‡∏á‡∏á"], 19, 30),
    ("night", "‡πÅ‡∏ã‡∏ß‡∏Å‡πà‡∏≠‡∏ô‡∏ô‡∏≠‡∏ô/‡∏ô‡∏≠‡∏ô‡∏ï‡∏µ‡∏û‡∏∏‡∏á", ["‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡πÄ‡∏ò‡∏≠‡∏ô‡∏≠‡∏ô‡∏ï‡∏µ‡∏û‡∏∏‡∏á‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏ô‡πà‡πÄ‡∏¢‡∏¢‡∏¢‡∏¢ ‡∏≠‡πâ‡∏ß‡∏ô‡∏ô‡πÜ"], 20, 30),
    ("bedtime", "‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏î‡∏∂‡∏Å/‡∏ä‡∏ß‡∏ô‡∏ö‡∏≠‡∏Å‡∏ù‡∏±‡∏ô‡∏î‡∏µ", ["‡∏ô‡∏≠‡∏ô‡∏¢‡∏≤‡∏á‡∏á‡∏á ‡∏≠‡∏¢‡πà‡∏≤‡∏ô‡∏≠‡∏ô‡∏î‡∏∂‡∏Å‡∏ô‡πâ‡∏≤‡∏≤ ‡∏à‡∏≤‡∏ô‡∏≠‡∏ô‡πÅ‡∏•‡πâ‡∏ß‡∏™‡πà‡∏á‡πÄ‡∏Ñ‡πâ‡∏≤‡∏î‡πâ‡∏ß‡∏¢‡∏¢‡∏¢"], 22, 0),
    ("late", "‡πÅ‡∏ã‡∏ß‡∏ß‡πà‡∏≤‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≠‡∏ô", ["‡πÅ‡∏´‡∏ô‡∏∞ ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ô‡∏≠‡∏ô‡∏≠‡∏µ‡∏Å‡∏Å ‡∏´‡∏∂‡πâ"], 23, 0),
]

def openai_generate_scheduled(schedule_id: str, meaning: str, examples: List[str]) -> str:
    recent = recent_scheduled.get(schedule_id, [])
    avoid = "\n".join([f"- {t}" for t in recent[-8:]]) if recent else ""
    ex = "\n".join([f"- {t}" for t in examples[:2]])

    prompt = (
        "‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏ß‡∏•‡∏≤ 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°\n"
        f"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏´‡∏°‡∏≤‡∏¢/‡∏à‡∏∏‡∏î‡∏õ‡∏£‡∏∞‡∏™‡∏á‡∏Ñ‡πå: {meaning}\n"
        "‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏ó‡∏ô/‡∏™‡πÑ‡∏ï‡∏•‡πå (‡∏´‡πâ‡∏≤‡∏°‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏ï‡∏£‡∏á‡πÜ):\n"
        f"{ex}\n\n"
        "‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:\n"
        "- ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏•‡πâ‡∏ß‡∏ô\n"
        "- ‡∏™‡∏±‡πâ‡∏ô‡∏ñ‡∏∂‡∏á‡∏Å‡∏•‡∏≤‡∏á (‡∏≠‡∏¢‡πà‡∏≤‡∏¢‡∏≤‡∏ß‡πÄ‡∏õ‡πá‡∏ô‡∏¢‡πà‡∏≠‡∏´‡∏ô‡πâ‡∏≤)\n"
        "- ‡πÅ‡∏ï‡πà‡∏á‡πÉ‡∏´‡∏°‡πà‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á\n"
    )
    if avoid:
        prompt += (
            "\n‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏Ñ‡∏¢‡∏™‡πà‡∏á (‡∏û‡∏¢‡∏≤‡∏¢‡∏≤‡∏°‡∏≠‡∏¢‡πà‡∏≤‡∏ã‡πâ‡∏≥):\n"
            f"{avoid}\n"
        )
    prompt += "\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÉ‡∏´‡∏°‡πà 1 ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°:"

    try:
        r = client.responses.create(
            model=MODEL,
            input=prompt,
            instructions=PERSONA_SYSTEM,
        )
        out = (getattr(r, "output_text", "") or "").strip()
        if not out:
            out = examples[0]
        remember_recent_map(recent_scheduled, schedule_id, out)
        return out
    except Exception as e:
        print("OpenAI scheduled error:", repr(e))
        out = examples[0]
        remember_recent_map(recent_scheduled, schedule_id, out)
        return out


def send_scheduled(schedule_id: str, meaning: str, examples: List[str]):
    msg = openai_generate_scheduled(schedule_id, meaning, examples)
    for uid in list(user_ids):
        try:
            line_bot_api.push_message(uid, TextSendMessage(text=msg))
        except Exception:
            pass
    print(f"[{datetime.now(timezone)}] Scheduled({schedule_id}) sent: {msg}")


# Register scheduler jobs
for schedule_id, meaning, examples, hour, minute in SCHEDULE_SLOTS:
    scheduler.add_job(
        send_scheduled,
        "cron",
        hour=hour,
        minute=minute,
        args=[schedule_id, meaning, examples],
        id=f"job_{schedule_id}",
        replace_existing=True,
    )

scheduler.start()


# =========================
# LINE webhook
# =========================
@app.route("/callback", methods=["POST"])
def callback():
    signature = request.headers.get("X-Line-Signature", "")
    body = request.get_data(as_text=True)

    try:
        handler.handle(body, signature)
    except InvalidSignatureError:
        abort(400)

    return "OK"


@handler.add(MessageEvent, message=TextMessage)
def handle_message(event):
    user_text = (event.message.text or "").strip()
    user_id = event.source.user_id
    user_ids.add(user_id)

    # keep original menu for ‡∏á‡∏á
    if user_text.lower() == "‡∏á‡∏á":
        reply_text = responses.get("‡∏á‡∏á", "‡∏û‡∏¥‡∏°‡∏û‡πå ‚Äú‡∏á‡∏á‚Äù ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡∏≥‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ô‡πâ‡∏≤‡∏Ñ‡πâ‡∏≤‡∏ö")
        line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))
        return

    reply_text = openai_generate_user_reply(user_text)
    remember_recent_list(recent_user_replies, reply_text)

    line_bot_api.reply_message(event.reply_token, TextSendMessage(text=reply_text))

if __name__ == "__main__":
    app.run(host="0.0.0.0", port=int(os.getenv("PORT", "10000")))
